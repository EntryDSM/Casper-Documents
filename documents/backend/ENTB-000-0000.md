# ENTB-000-0000: 사용자 인증 시스템 구현

---
## 요약
이 문서는 사용자 인증을 위한 REST API 개발에 관한 설계를 기술합니다. 회원가입, 로그인, 토큰 갱신, 비밀번호 재설정 기능을 포함합니다.

---
## 동기
현재 시스템은 사용자 인증 기능이 부재하여 사용자별 데이터 관리와 보안 유지가 어렵습니다. 안전하고 표준화된 인증 시스템을 구축하여 사용자 경험을 향상시키고 보안 수준을 높이고자 합니다.

### 목표
- JWT 기반 인증 시스템 구현
- 회원가입 및 이메일 인증 기능 개발
- 보안된 로그인 프로세스 구현
- 토큰 갱신 메커니즘 개발
- 비밀번호 재설정 기능 구현

### 목표가 아닌 것
- 소셜 로그인 연동 (차후 개발 예정)
- 사용자 권한 관리 시스템 (별도 모듈로 개발 예정)
- 다중 인증(2FA) 구현 (향후 확장 기능)

---
## 제안

### 기술 설계

데이터 모델 :

```
Entity
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true)
    private String email;
    
    @Column(nullable = false)
    private String password;
    
    @Column(name = "first_name")
    private String firstName;
    
    @Column(name = "last_name")
    private String lastName;
    
    @Column(name = "is_active", nullable = false)
    private boolean isActive = false;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    // Getters and Setters
}
```

```
Request Object
public class SignupRequest {
    @NotBlank
    @Email
    private String email;
    
    @NotBlank
    @Size(min = 8, max = 30)
    private String password;
    
    @NotBlank
    private String firstName;
    
    @NotBlank
    private String lastName;
    
    // Getters and Setters
}

public class LoginRequest {
    @NotBlank
    @Email
    private String email;
    
    @NotBlank
    private String password;
    
    // Getters and Setters
}

public class TokenRefreshRequest {
    @NotBlank
    private String refreshToken;
    
    // Getters and Setters
}

public class PasswordResetRequest {
    @NotBlank
    @Email
    private String email;
    
    // Getters and Setters
}
```

```
Response Object
public class AuthResponse {
    private String tokenType = "Bearer";
    private String accessToken;
    private String refreshToken;
    private Long expiresIn;
    
    // Getters and Setters
}

public class MessageResponse {
    private String message;
    
    // Getters and Setters
}
```

API 엔드포인트 설계 :

```
POST / "api/v1/auth/signup" / None / Public / SignupRequest / MessageResponse
POST / "api/v1/auth/login" / None / Public / LoginRequest / AuthResponse
POST / "api/v1/auth/refresh" / None / Public / TokenRefreshRequest / AuthResponse
POST / "api/v1/auth/resetpassword" / None / Public / PasswordResetRequest / MessageResponse
GET / "api/v1/auth/confirm" / ?token={token} / Public / None / MessageResponse
```

API 오류 반환 :

- 400 Bad Request: 유효하지 않은 요청 형식 또는 데이터
- 401 Unauthorized: 인증 실패, 잘못된 자격 증명
- 403 Forbidden: 접근 권한 없음
- 404 Not Found: 요청한 리소스를 찾을 수 없음
- 409 Conflict: 리소스 충돌 (예: 중복된 이메일)
- 500 Internal Server Error: 서버 오류

---
## 검토 설문

### 로깅
- 모든 인증 시도 (성공/실패)를 로깅
- 비밀번호 재설정 요청 로깅
- 토큰 갱신 시도 로깅
- 로그에는 민감 정보(비밀번호, 토큰)를 포함하지 않음

### 의존성

```
impl "org.springframework.boot:spring-boot-starter-security"
impl "org.springframework.boot:spring-boot-starter-data-jpa"
impl "io.jsonwebtoken:jjwt-api:0.11.5"
impl "io.jsonwebtoken:jjwt-impl:0.11.5"
impl "io.jsonwebtoken:jjwt-jackson:0.11.5"
impl "org.springframework.boot:spring-boot-starter-mail"
```

### 트러블슈팅
- JWT 토큰 검증 실패 시 디버깅 방법
  - 로그에서 토큰 만료 여부 확인
  - 시크릿 키 환경 변수 설정 확인
  - 클라이언트 토큰 저장 방식 점검
- 이메일 발송 실패 대응 방안
  - SMTP 서버 접속 상태 확인
  - 이메일 템플릿 오류 확인
  - 재시도 메커니즘 적용
- 데이터베이스 연결 문제 해결 방법
  - DB 접속 정보 확인
  - 스키마 마이그레이션 상태 확인
  - 연결 풀 설정 검토

---
## 대안

1. 세션 기반 인증 방식: 확장성 측면에서 JWT가 더 적합하다고 판단
   - 장점: 구현이 단순하고 서버에서 세션 무효화가 쉬움
   - 단점: 서버 확장 시 세션 동기화 문제 발생
   
2. OAuth2 인증: 자체 인증 시스템 구축 후 소셜 로그인을 추가 구현하는 접근 방식 선택
   - 장점: 사용자가 새 계정을 만들 필요 없음
   - 단점: 외부 서비스 의존성 생성, 통합 복잡성 증가
   
3. 기존 인증 라이브러리 사용: 커스터마이징 요구사항이 많아 자체 구현 선택
   - 장점: 빠른 구현 가능
   - 단점: 커스터마이징 제약 발생

---
## 보안 고려 사항
- 모든 비밀번호는 BCrypt로 해시 처리
- HTTPS 통신 적용 필수
- 토큰 만료 시간 적절히 설정 (AccessToken: 15분, RefreshToken: 7일)
- 토큰 저장소 구현하여 로그아웃 시 블랙리스트 처리
- 비밀번호 정책 구현 (8자 이상, 특수문자 1개 이상 등)
- 로그인 시도 제한 (5분 동안 5회 이상 실패 시 계정 잠금)
